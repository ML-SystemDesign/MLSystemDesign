# **Дизайн-документ проекта**

### «Оценка стоимости простоя по результатам инцидента на финансовом маркетплейсе»

### ***Лист изменений***

| Дата       | Редакция | Описание                                               | Автор        |
| ---------- | -------- | ------------------------------------------------------ | ------------ |
| 24.07.2024 | 1.0      | Подготовлена примерная структура документа             | Аксенов Э.В. |
| 06.08.2024 | 1.1      | Обновление раздела "[Аббревиатуры, определения и сокращения](#аббревиатуры-определения-и-сокращения)", добавлен пункт о "[Описание типов инцидентов и их частоты](#описание-типов-инцидентов-и-их-частоты)" | Ломоносов И.В |
| 06.08.2024 | 1.2      | Обновление разделов "[Проблемы предметной области](#проблемы-предметной-области)" и "[Ограничения на решение задачи](#ограничения-на-решение-задачи)" | Куляскин М.О. |
| 10.08.2024 | 1.3      | Обновление раздела "[Ограничения на решение задачи](#ограничения-на-решение-задачи)" | Куляскин М.О. |
| 18.08.2024 | 1.4      | Добавление разделов 4, 6, 7                            | Куляскин М.О. |
| 25.08.2024 | 1.5      | Добавление раздела "[Данные](#данные)"                         | Вашкевич А.К. |

### **Оглавление**

1. [Назначение документа](#назначение-документа)
2. [Аббревиатуры, определения и сокращения](#аббревиатуры-определения-и-сокращения)
3. [Постановка задачи](#постановка-задачи)
   - [Предпосылки](#предпосылки)
   - [Актуальность и причины](#актуальность-и-причины)
   - [Описание типов инцидентов и их частоты](#описание-типов-инцидентов-и-их-частоты)
   - [Существующий анализ потоков](#существующий-анализ-потоков)
   - [Проблемы предметной области](#проблемы-предметной-области)
   - [Ограничения на решение задачи](#ограничения-на-решение-задачи)
   - [Существующие решения](#существующие-решения)
4. [Метрики и функции потерь](#метрики-и-функции-потерь)
   - [Метрики](#метрики)
   - [Функции потерь](#функции-потерь)
5. [Данные](#данные)
6. [Схема валидации](#схема-валидации)
7. [Разработка бейзлайн моделей](#разработка-бейзлайн-моделей)


## Назначение документа

Данный дизайн документа подробно описывает этапы решения задачи и необходим для:

* Фиксации и обоснования принимаемых в процессе реализации проекта решений, допущений и используемых методов / технологий;  
* Погружения нового участника проекта в ключевые аспекты предметной области и процесс реализации проекта;  
* Возможности анализа качества проводимого исследования и последующего выявления потенциальных ошибок, проблем, несостоявшихся гипотез и т.д.;  
* Формирования дальнейших артефактов проекта на базе промежуточных результатов проводимого исследования.

## Аббревиатуры, определения и сокращения

* Компания – финансовая организация, выступающая в роли Заказчика на разработку дизайн-документа 

* **DWH** – Data Warehouse (Хранилище данных)

* **ETL** – Extract, Transform, Load (Извлечение, Преобразование, Загрузка)

* **JIRA** – Система для управления задачами и инцидентами

* **Snowflake** – Облачное хранилище данных, предоставляющее возможности для хранения, обработки и аналитики больших объемов данных.

* **Транзакция** – Запись о продаже услуги, включающая информацию о продукте, сумме комиссии и времени продажи

* **Комиссия** – Финансовое вознаграждение, получаемое компанией за успешные транзакции

* **Инцидент** – Событие, вызывающее простой системы или ухудшение ее производительности

## Постановка задачи

Для продуктов компании необходимо оценить стоимость простоя в результате инцидента

### Предпосылки

Компания продает продукты услуг выбора продуктов разных видов страхования машин, квартир и т.д.

В каждом продукте есть витрина выдачи, где пользователь может выбрать предложения различных страховых фирм и подобрать наиболее подходящее для себя предложение.

На продажах услуг построена экономика компании за счет получения комиссии с каждой успешной транзакции пользователя. Каждая такая продажа логгируется и известно какой продукт продавался, сколько с этого продукта компания получила комиссии, время транзакции. Все данные находятся в витрине snowflake. 

### Актуальность и причины

Оценка стоимости простоя продуктов важна для компании, так как позволяет определить финансовые потери из\-за недоступности сервисов. Это помогает понять, какие инциденты обходятся дороже всего и когда они происходят, что способствует улучшению управления инцидентами и повышению эффективности бизнеса.

### Описание типов инцидентов и их частоты

#### **1. Сбой внешнего поставщика услуг**

**Описание:** Это инцидент, когда внешний сервис, на который полагается компания для предоставления своих услуг, становится недоступным или начинает работать некорректно. Это может быть, например, сервис проверки кредитной истории, платежный шлюз или сервис идентификации пользователей.

**Пример:** Внешний API для проверки страховых полисов временно не отвечает из\-за технических проблем у провайдера. 

**Частота:** Происходит периодически, в зависимости от надежности внешнего поставщика.

#### **2. Атака типа DDoS**

**Описание:** Distributed Denial of Service (DDoS) атака представляет собой злонамеренное действие, направленное на перегрузку инфраструктуры компании путем одновременной отправки большого количества запросов с множества устройств. Это приводит к недоступности сервисов для легитимных пользователей. 

**Пример:** Хакеры запускают массовую атаку на сайт компании, что приводит к значительному замедлению работы или полной недоступности сервиса. 

**Частота:** Встречается редко, но может иметь серьезные последствия.

#### **3. Критический программный сбой**

**Описание:** Это критическая ошибка в программном обеспечении, которая полностью блокирует работу определенного продукта или всей системы. Такие сбои часто требуют срочного вмешательства разработчиков для устранения проблемы.

**Пример:** Ошибка в обновлении кода приводит к невозможности завершения транзакций на витрине страховых продуктов. 

**Частота:** Может возникать случайно, обычно в процессе внедрения новых функций или обновлений.

#### **4. Недоступность внутренней инфраструктуры**

**Описание:** Этот инцидент возникает, когда один или несколько компонентов внутренней инфраструктуры компании выходят из строя. Это может быть связано с аппаратными сбоями, программными ошибками или проблемами в сети. 

**Пример:** Внутренняя база данных, используемая для хранения информации о пользователях и транзакциях, становится недоступной из\-за аппаратного сбоя. 

**Частота:** Происходит редко, но может привести к значительным убыткам из\-за полной недоступности сервисов.

### Существующий анализ потоков

Фиксация инцидентов:

* Регистрация инцидентов: При возникновении инцидента команда инцидент-менеджмента создает задачу в JIRA. Задача содержит следующие данные: идентификатор инцидента(INCIDENT\_ID), начала инцидента дата и время (INCIDENT\_START\_DTM), конец инцидента дата и время (INCIDENT\_END\_DTM). И продукты (PRODUCT\_NAME) из продуктов будет Кредиты (Credits), Вклады (Deposits), Займы (Loans), Страховки (Policies).  
* Сохранение данных: Данные из JIRA автоматически поступают в витрину данных Snowflake для последующего анализа.

Логирование продаж:

* Регистрация продаж: Каждая продажа логгируется, фиксируя идентификатор события (EVENT\_ID), название продукта (PRODUCT\_NAME), временную метку (EVENT\_DATETIME) и доход (INCOME).  
* Информация о пользователе: В некоторых случаях фиксируется идентификатор пользователя, если покупка была сделана с регистрацией.  
* Хранение данных: Все данные по продажам хранятся в реляционной базе данных.

### **Проблемы предметной области**

- **Дисбаланс данных:** Случается всего 1-6 инцидентов в месяц, при среднем количестве продаж в 2000-3000 в день, что приводит к сильному дисбалансу классов.

- **Качество данных:** Инциденты добавляются вручную, что может снижать точность данных.

- **Пропуски в целевой переменной:** В большинстве случаев значение таргета равно 0, так как простой системы происходит редко.

- **Отсутствие истинных меток:** Нет достоверных данных о потерях во время простоев для обучения модели.

- **Гранулярность прогноза:** Для разных инцидентов требуется разная детализация прогнозов. Должна быть возможность оценивать простои как на уровне минут, так и на уровне дней, с минимальной единицей данных в один час.

### Ограничения на решение задачи

* Данные доступны только с 2022 года, что ограничивает исторический контекст.
* Система разрабатывается для использования инцидент-менеджерами и владельцами продуктов, по которым произошел инцидент  
* Ранее чем через день после поломки в прогнозе не будет необходимости, так как разбор инцидентов проводится позднее. Задержка длительностью в день устроит бизнес и даст инженерам больше свободы при разработке.   
* В ресурсах компании есть как CPU, так и GPU, что позволит эффективно тестировать гипотезы во время разработки моделей. Использование GPU менее желательно и требует обоснования в виде существенного улучшения качества модели.   
* Бизнес хочет получить интерпретируемую модель, чтобы наглядно видеть почему она выдала тот или иной результат. Также требуется вероятностная оценка уверенности модели в своем ответе. 

### Существующие решения
Отсутствует.

## Метрики и функции потерь

  ### Метрики

   Нашей метрикой качества будет WAPE (WMAPE) \- Weighted Absolute Percent Error как наименее чувствительная к искажениям числового ряда. 

  ![](https://github.com/PsihAnalitik/Design_document/blob/feature-add-image/pics/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202024-08-27%20%D0%B2%2022.11.43.png)


1. Для каждой позиции рассчитывается абсолютная ошибка прогноза (прогноз вычитается из факта, по модулю) — Absolute Error  
2. Находится сумма всех фактов по всем позициям (общий фактический объем)  
3. Сумма всех абсолютных ошибок делится на сумму всех фактов — WAPE

  ### Функции потерь

   В качестве функции потерь для бейзлайна будем пробовать использовать MSE, MAE, RMSE. Для более продвинутых моделей попробуем использовать квантильные лоссы. Обучение отдельной модели под предсказание каждого квантиля позволит оценить доверительный интервал нашей ошибки, что может быть полезно при интерпретации результатов для бизнеса. Так как мы не сможем оценить реальную ошибку на периодах инцидентов, будет плюсом, если мы по крайней мере сможем предоставить информацию о том, с какой вероятностью наши потери были в некотором диапазоне значений. 

## Данные
  Фактически разметки данных нет. В моменты времени когда нет инцидентов, известно сколько продукты маркетплейса принесли денег. В моменты инцидентов из-за простоя какой-либо системы неизвестно сколько компания потеряла денег в результате нереализации продаж.
Чтобы решить эту проблему решено обучить модель на данных без простоев оценивать сколько денег принес каждый продукт за некоторый промежуток времени, оптимизировать качество модели на данных с разметкой и применить ее на данных с инцидентами, предсказания модели на таких данных и будут оценкой простоя 

## Схема валидации

   Схема валидации для одного продукта будет представлять собой следующее:

  ![](https://github.com/PsihAnalitik/Design_document/blob/feature-add-image/pics/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202024-08-27%20%D0%B2%2016.12.01.png)

   Мы выделяем валидационный сет, по времени равный длительности инцидента. Обучаем нашу модель или считаем эвристику бейзлайна на Train 1\. Train 1 Представляет собой датасет с выручкой за некоторый период до валидации (размер подберем экспериментально). Валидация будет основой для подбора гиперпараметров ML моделей. Затем объединяем Train 1 и Val, обучаем новую модель, а затем делаем предикты и делаем прогноз на данные с период инцидентамита. В  качестве прокси метрики используем показатели на Val.

## Разработка бейзлайн моделей

### Наивное предсказание усреднением

Этот подход предполагает использование среднего значения целевой переменной за предыдущий период, равный времени простоя, или нескольких периодов в рамках сезонности продаж продукта.

**Пример:** Продукт A был частично недоступен, так как некоторые пользователи не могли получить доступ к платежному сервису с 12:00 до 15:00 во вторник. В качестве базовой линии мы используем средние продажи этого продукта за аналогичное время по вторникам за последние три недели. Мы вычитаем фактический доход из этого среднего, чтобы определить наши потери.

### Модели ARIMA и sARIMA

Модели ARIMA (AutoRegressive Integrated Moving Average) используются как начальное приложение машинного обучения благодаря их простоте.

### Prophet

Этот инструмент прогнозирования полезен для временных рядов и учитывает сезонные эффекты и тренды.

### Линейная регрессия

Начав с линейных моделей, можно заняться созданием признаков (feature engineering), что потребует дополнительных усилий, но может улучшить производительность модели.

### Градиентный бустинг

Создавая признаки, такие как прошлые продажи (средние значения, скользящие окна с расчетом среднего, медианы, минимума, максимума), частота продаж и исторические цены на услуги, можно использовать градиентный бустинг на деревьях для достижения хорошей точности модели.

### Рекуррентные нейронные сети (RNN, GRU, LSTM)

Рекуррентные нейронные сети (GRU и LSTM) можно протестировать при необходимости, хотя они требуют больше времени на разработку и вычислительные ресурсы.

### Transformers

Если предыдущие модели покажут, что подходы с использованием нейронных сетей оправданы, можно протестировать трансформеры для решения нашей задачи.

